<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebM zu MP3 Konverter</title>

    <!-- 
      WICHTIG: Lädt jetzt die LOKALE Datei coi-serviceworker.js
      Diese muss im selben Ordner liegen!
    -->
    <script src="./coi-serviceworker.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f4f9; color: #333; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #2c3e50; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .upload-area { border: 2px dashed #bdc3c7; padding: 30px; text-align: center; border-radius: 6px; cursor: pointer; transition: 0.3s; background: #fafafa; }
        .upload-area:hover { background-color: #ecf0f1; border-color: #3498db; }
        .file-list { list-style: none; padding: 0; margin-top: 20px; }
        .file-item { background: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 8px; display: flex; align-items: center; border-radius: 4px; }
        .file-name { font-weight: bold; flex-grow: 1; margin: 0 15px; word-break: break-all; }
        button { cursor: pointer; padding: 6px 12px; border: none; border-radius: 4px; font-size: 14px; margin-left: 5px; }
        .btn-up, .btn-down { background-color: #3498db; color: white; }
        .btn-remove { background-color: #e74c3c; color: white; }
        .btn-action { background-color: #27ae60; color: white; padding: 15px; font-size: 18px; width: 100%; margin-top: 20px; font-weight: bold;}
        .btn-action:disabled { background-color: #95a5a6; cursor: wait; }
        .options { margin-top: 20px; padding: 15px; background: #ecf0f1; border-radius: 6px; }
        .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 12px; }
        .field label { font-weight: bold; }
        .text-input { padding: 8px 10px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 14px; }
        .radio-group label { display: block; margin-bottom: 10px; cursor: pointer; }
        #log { margin-top: 20px; font-family: monospace; font-size: 11px; background: #222; color: #0f0; padding: 10px; border-radius: 4px; height: 150px; overflow-y: auto; display: none; }
        .progress-container { margin-top: 15px; background-color: #ddd; border-radius: 4px; height: 20px; display: none; overflow: hidden; }
        .progress-bar { height: 100%; background-color: #27ae60; width: 0%; transition: width 0.2s; text-align: center; color: white; font-size: 12px; line-height: 20px; }
    </style>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>

    <div class="container">
        <h1>WebM ➔ MP3 Konverter</h1>
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
            <p>Dateien hierher ziehen oder klicken</p>
            <input type="file" id="fileInput" multiple accept=".webm" style="display: none;" onchange="handleFiles(this.files)">
        </div>

        <ul class="file-list" id="fileList"></ul>

        <div class="options" id="optionsPanel" style="display:none;">
            <h3>Ausgabe-Optionen</h3>
            <div class="field">
                <label for="nameInput">Name</label>
                <input id="nameInput" class="text-input" type="text" placeholder="z.B. Meeting">
            </div>
            <div class="radio-group">
                <label><input type="radio" name="outputMode" value="merge" checked> Zusammenfügen (Merge)</label>
                <label><input type="radio" name="outputMode" value="zip"> Einzeldateien (ZIP)</label>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>

        <button id="convertBtn" class="btn-action" style="display:none;" onclick="startProcessing()">Konvertierung starten</button>
        <div id="log"></div>
    </div>

    <script>
        let selectedFiles = [];
        const { createFFmpeg, fetchFile } = FFmpeg;
        let ffmpeg = null;

        const dropArea = document.querySelector('.upload-area');
        const nameInput = document.getElementById('nameInput');
        nameInput.dataset.user = "0";
        nameInput.addEventListener('input', () => {
            nameInput.dataset.user = nameInput.value.trim() ? "1" : "0";
        });
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, e => {e.preventDefault(); e.stopPropagation();}, false));
        dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));

        function handleFiles(files) {
            for (let file of files) if (file.name.toLowerCase().endsWith('.webm')) selectedFiles.push(file);
            renderList();
        }

        function inferNameFromFileName(fileName) {
            const base = fileName.replace(/\.[^/.]+$/, "");
            const parts = base.split("-");
            if (parts.length >= 4 && parts[0]) return parts[0];
            return base;
        }

        function updateDefaultName() {
            if (nameInput.dataset.user === "1") return;
            if (selectedFiles.length === 0) {
                nameInput.value = "";
                return;
            }
            const inferred = selectedFiles.map(f => inferNameFromFileName(f.name)).filter(Boolean);
            nameInput.value = inferred[0] || "";
        }

        function sanitizeName(name) {
            return name.replace(/[\\/:*?"<>|]+/g, "").trim();
        }

        function renderList() {
            const listEl = document.getElementById('fileList');
            listEl.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                listEl.innerHTML += `
                    <li class="file-item">
                        <span class="file-name">${file.name}</span>
                        <div>
                            <button class="btn-up" onclick="move(${index}, -1)">▲</button>
                            <button class="btn-down" onclick="move(${index}, 1)">▼</button>
                            <button class="btn-remove" onclick="rem(${index})">✕</button>
                        </div>
                    </li>`;
            });
            const hasFiles = selectedFiles.length > 0;
            document.getElementById('optionsPanel').style.display = hasFiles ? 'block' : 'none';
            document.getElementById('convertBtn').style.display = hasFiles ? 'block' : 'none';
            updateDefaultName();
        }

        function move(idx, dir) {
            if (idx + dir < 0 || idx + dir >= selectedFiles.length) return;
            [selectedFiles[idx], selectedFiles[idx + dir]] = [selectedFiles[idx + dir], selectedFiles[idx]];
            renderList();
        }

        function rem(idx) { selectedFiles.splice(idx, 1); renderList(); }

        function log(msg) {
            const l = document.getElementById('log');
            l.style.display = 'block';
            l.innerText += `> ${msg}\n`;
            l.scrollTop = l.scrollHeight;
        }

        async function loadFFmpeg() {
            if (ffmpeg) return;
            log("Lade FFmpeg...");
            try {
                ffmpeg = createFFmpeg({ log: true });
                await ffmpeg.load();
                log("FFmpeg bereit.");
            } catch (e) {
                log("Fehler beim Laden: " + e.message);
                if(e.message.includes("SharedArrayBuffer")) alert("Fehler: SharedArrayBuffer nicht verfügbar. Server-Header fehlen.");
                throw e;
            }
        }

        async function startProcessing() {
            if (selectedFiles.length === 0) return;
            const btn = document.getElementById('convertBtn');
            const pBar = document.getElementById('progressBar');
            const mode = document.querySelector('input[name="outputMode"]:checked').value;
            const baseNameRaw = nameInput.value.trim();
            const baseName = baseNameRaw ? sanitizeName(baseNameRaw) : "";

            btn.disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            pBar.style.width = '5%';

            try {
                await loadFFmpeg();
                const inputNames = [];
                for (let i = 0; i < selectedFiles.length; i++) {
                    const fname = `in${i}.webm`;
                    inputNames.push(fname);
                    ffmpeg.FS('writeFile', fname, await fetchFile(selectedFiles[i]));
                }
                
                pBar.style.width = '20%';

                if (mode === 'zip') {
                    const zip = new JSZip();
                    const nameCounts = {};
                    for (let i = 0; i < inputNames.length; i++) {
                        const outName = `track${i}.mp3`;
                        log(`Konvertiere ${selectedFiles[i].name}...`);
                        await ffmpeg.run('-i', inputNames[i], '-vn', '-acodec', 'libmp3lame', '-q:a', '2', outName);
                        const baseFromWebm = selectedFiles[i].name.replace(/\.[^/.]+$/, "");
                        const base = sanitizeName(baseFromWebm) || `track${i + 1}`;
                        nameCounts[base] = (nameCounts[base] || 0) + 1;
                        const unique = nameCounts[base] === 1 ? base : `${base}-${nameCounts[base]}`;
                        zip.file(unique + ".mp3", ffmpeg.FS('readFile', outName));
                        ffmpeg.FS('unlink', inputNames[i]); ffmpeg.FS('unlink', outName);
                        pBar.style.width = `${20 + ((i+1) / inputNames.length * 70)}%`;
                    }
                    const zipName = baseName ? `${baseName}.zip` : "mp3_sammlung.zip";
                    download(await zip.generateAsync({type:"blob"}), zipName);
                } else {
                    log("Merge Dateien...");
                    ffmpeg.FS('writeFile', 'list.txt', inputNames.map(n => `file '${n}'`).join('\n'));
                    await ffmpeg.run('-f', 'concat', '-safe', '0', '-i', 'list.txt', '-vn', '-acodec', 'libmp3lame', '-q:a', '2', 'output.mp3');
                    const outName = baseName ? `${baseName}.mp3` : "audio_komplett.mp3";
                    download(new Blob([ffmpeg.FS('readFile', 'output.mp3').buffer], {type: 'audio/mp3'}), outName);
                    ffmpeg.FS('unlink', 'output.mp3'); ffmpeg.FS('unlink', 'list.txt');
                    inputNames.forEach(n => ffmpeg.FS('unlink', n));
                }
                pBar.style.width = '100%'; pBar.innerText = 'Fertig!';
            } catch (err) {
                log("FEHLER: " + err.message);
                console.error(err);
            } finally {
                btn.disabled = false;
            }
        }

        function download(blob, name) {
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }
    </script>
</body>
</html>
